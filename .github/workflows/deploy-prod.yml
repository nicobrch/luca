name: Deploy Prod

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.PROD_GCP_PROJECT_ID }}
  REGION: us-central1
  SERVICE_NAME: luca-backend
  ARTIFACT_REPO: luca

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.PROD_GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.PROD_GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Sync Secrets to GCP
        run: |
          chmod +x scripts/sync_secrets_to_gcp.sh
          ./scripts/sync_secrets_to_gcp.sh "$PROJECT_ID"
        env:
          # Using PROD_ prefixed secrets from GitHub
          GOOGLE_API_KEY: ${{ secrets.PROD_GOOGLE_API_KEY }}
          WHATSAPP_API_TOKEN: ${{ secrets.PROD_WHATSAPP_API_TOKEN }}
          WHATSAPP_PHONE_NUMBER_ID: ${{ secrets.PROD_WHATSAPP_PHONE_NUMBER_ID }}
          WEBHOOK_VERIFY_TOKEN: ${{ secrets.PROD_WEBHOOK_VERIFY_TOKEN }}

      - name: Configure Docker
        run: gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Build and Push Container
        run: |
          IMAGE_NAME="$REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/$SERVICE_NAME:${{ github.sha }}"
          docker build -t "$IMAGE_NAME" .
          docker push "$IMAGE_NAME"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE_NAME \
            --region $REGION \
            --project $PROJECT_ID \
            --platform managed \
            --allow-unauthenticated \
            --set-secrets="GOOGLE_API_KEY=luca-GOOGLE-API-KEY:latest,WHATSAPP_API_TOKEN=luca-WHATSAPP-API-TOKEN:latest,WHATSAPP_PHONE_NUMBER_ID=luca-WHATSAPP-PHONE-NUMBER-ID:latest,WEBHOOK_VERIFY_TOKEN=luca-WEBHOOK-VERIFY-TOKEN:latest"
